<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SentinelZero Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body, h1, h2, h3, h4, h5, h6 {
        font-family: 'Inter', Arial, sans-serif;
      }
      .header {
        position: fixed;
        top: 0; left: 0; right: 0;
        z-index: 1030;
        width: 100vw;
        background: rgba(24, 26, 27, 0.85);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        color: #fff;
        padding: 0.75rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .sidebar {
        position: fixed;
        top: 64px;
        left: 0;
        bottom: 0;
        width: 220px;
        background: #23272b;
        color: #f8f9fa;
        padding: 2rem 1rem 1rem 1rem;
        box-shadow: 2px 0 12px rgba(0,0,0,0.12), 0 0 0 1px #2c2f34;
        z-index: 1020;
        border-right: 1.5px solid #2c2f34;
      }
      .sidebar .nav-link {
        color: #f3f6fa !important;
        margin-bottom: 0.5rem;
        font-weight: 500;
        transition: background 0.2s, color 0.2s;
        text-shadow: 0 1px 2px rgba(0,0,0,0.18);
      }
      .sidebar .nav-link.active, .sidebar .nav-link:hover {
        background: #343a40;
        border-radius: 0.375rem;
        color: #fff !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        text-shadow: 0 2px 8px rgba(0,0,0,0.18);
      }
      .main-content {
        margin-left: 240px;
        margin-top: 104px; /* Increased for more space below header */
        padding: 2rem 2rem 2rem 2rem;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        background: rgba(30, 33, 36, 0.6) !important;
        color: #f8f9fa !important;
        border: none !important;
      }
      .card-header {
        background: rgba(24, 26, 27, 0.85) !important;
        border-bottom: none !important;
      }
      .card-body {
        background: rgba(30, 33, 36, 0.6) !important;
      }
      .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .dashboard-card {
        position: relative;
        padding: 1rem;
        border-radius: 1.5rem 0.6rem 1.5rem 0.6rem;
        background: rgba(30, 33, 36, 0.6);
        backdrop-filter: blur(8px);
        box-shadow:
          0 4px 12px rgba(0,0,0,0.15),
          inset 0 1px 0 rgba(255,255,255,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .dashboard-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 40%;
        height: 4px;
        background: var(--bs-primary);
      }
      .dashboard-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow:
          0 8px 20px rgba(0,0,0,0.25),
          inset 0 1px 0 rgba(255,255,255,0.06);
      }
      
      .dashboard-card.clicked {
        animation: cardClick 0.3s ease-out;
      }
      
      @keyframes cardClick {
        0% { transform: scale(1); }
        50% { transform: scale(0.95); }
        100% { transform: scale(1); }
      }
      
      .modal-xl {
        max-width: 90vw;
      }
      
      .modal-xl .modal-body {
        max-height: 70vh;
        overflow-y: auto;
      }
      .dashboard-card .icon {
        font-size: 1.8rem;
        margin-bottom: 0.4rem;
        transition: transform 0.2s ease;
      }
      .dashboard-card:hover .icon {
        transform: scale(1.15);
        opacity: 0.9;
      }
      .dashboard-card .count {
        font-size: 1.9rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
      }
      .dashboard-card .label {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
      }
      .table-responsive {
        border-radius: 1rem;
        overflow: hidden;
      }
      .live-log {
        background: #181a1b;
        color: #00ffae;
        font-family: monospace;
        height: 160px;
        overflow-y: auto;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1.5px solid #2c2f34;
        box-shadow: 0 2px 8px rgba(0,255,174,0.04);
      }
      .theme-toggle {
        cursor: pointer;
        font-size: 1.3rem;
        margin-left: 1rem;
        transition: transform 0.3s cubic-bezier(.68,-0.55,.27,1.55);
        display: inline-block;
      }
      .theme-toggle.animated {
        transform: rotate(360deg) scale(1.2);
      }
      .toast-container {
        position: fixed;
        top: 1.5rem;
        right: 2rem;
        z-index: 2000;
      }
      .empty-state {
        text-align: center;
        color: #888;
        padding: 2.5rem 0;
      }
      .empty-state i {
        font-size: 2.5rem;
        opacity: 0.4;
        margin-bottom: 0.5rem;
        display: block;
      }
      .btn-spinner {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn-spinner .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-left: 0.5rem;
      }
      @media (max-width: 900px) {
        .sidebar { display: none; }
        .main-content { margin-left: 0; }
      }

      /* —— Dark-mode text color fixes —— */
      body.bg-dark {
        --sz-text-light: #f8f9fa;
      }
      body.bg-dark,
      body.bg-dark .main-content,
      body.bg-dark .dashboard-card,
      body.bg-dark .card,
      body.bg-dark .card-header,
      body.bg-dark .card-body,
      body.bg-dark .table,
      body.bg-dark .table th,
      body.bg-dark .table td,
      body.bg-dark .form-label,
      body.bg-dark .form-select,
      body.bg-dark .live-log,
      body.bg-dark .sidebar .nav-link,
      body.bg-dark .header,
      body.bg-dark .btn {
        color: var(--sz-text-light) !important;
      }

      /* Dark-mode table and form overrides */
      body.bg-dark .table th,
      body.bg-dark .table td {
        color: #f8f9fa !important;
      }
      body.bg-dark .form-select,
      body.bg-dark .form-select option,
      body.bg-dark .form-select:focus {
        background-color: rgba(30,33,36,0.6) !important;
        color: #f8f9fa !important;
        border-color: #495057 !important;
      }
      body.bg-dark .form-label {
        color: #f8f9fa !important;
      }

      /* Dark-mode Last 5 Scans table styling */
      body.bg-dark .card-body.table-responsive {
        background: rgba(30, 33, 36, 0.6) !important;
        border-radius: 1rem;
      }
      body.bg-dark .table {
        background: transparent !important;
      }
      body.bg-dark .table-hover tbody tr:hover {
        background-color: rgba(255,255,255,0.1) !important;
      }
      body.bg-dark .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(255,255,255,0.04) !important;
      }
      body.bg-dark .table-striped tbody tr:nth-of-type(even) {
        background-color: transparent !important;
      }
      body.bg-dark .table thead {
        background: rgba(24,26,27,0.85) !important;
      }

      /* Force high-contrast for table in dark mode */
      body.bg-dark .table,
      body.bg-dark .table th,
      body.bg-dark .table td,
      body.bg-dark .table thead th,
      body.bg-dark .table-dark th,
      body.bg-dark .table-dark td,
      body.bg-dark .table-dark {
        color: #f8fafd !important;
        background-color: #23272b !important;
      }
      body.bg-dark .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #23272b !important;
      }
      body.bg-dark .table-striped > tbody > tr:nth-of-type(even) {
        background-color: #181a1b !important;
      }
      body.bg-dark .table-hover tbody tr:hover {
        background-color: #2a2e33 !important;
      }

      /* —— Light-mode overrides —— */
      body.bg-light {
        --sz-bg: #f8f9fa;
        --sz-text: #212529;
        --sz-card-bg: #ffffff;
        --sz-card-border: #dee2e6;
        --sz-header-bg: #e9ecef;
        --sz-sidebar-bg: #ffffff;
        --sz-sidebar-text: #343a40;
      }

      body.bg-light {
        background: var(--sz-bg) !important;
        color: var(--sz-text) !important;
      }

      /* Cards */
      body.bg-light .card,
      body.bg-light .dashboard-card {
        background: var(--sz-card-bg) !important;
        color: var(--sz-text) !important;
        border: 1px solid var(--sz-card-border) !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
        backdrop-filter: none !important;
      }

      /* Card headers */
      body.bg-light .card-header {
        background: var(--sz-header-bg) !important;
        color: var(--sz-text) !important;
        border-bottom: 1px solid var(--sz-card-border) !important;
      }

      /* Dashboard widgets accent stripe */
      body.bg-light .dashboard-card::before {
        background: var(--bs-primary) !important;
      }

      /* Live log box */
      body.bg-light .live-log {
        background: #212529;
        color: #c3e88d;
        border: 1px solid #495057;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      /* Sidebar */
      body.bg-light .sidebar {
        background: var(--sz-sidebar-bg) !important;
        color: var(--sz-sidebar-text) !important;
        border-right-color: var(--sz-card-border) !important;
      }
      body.bg-light .sidebar .nav-link {
        color: var(--sz-sidebar-text);
      }
      body.bg-light .sidebar .nav-link.active,
      body.bg-light .sidebar .nav-link:hover {
        background: #e2e6ea;
        color: var(--sz-sidebar-text);
      }

      /* Header */
      body.bg-light .header {
        background: var(--sz-header-bg) !important;
        color: var(--sz-text) !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      }

      /* Button adjustments */
      body.bg-light .btn-primary {
        background: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
      }
      .logo-img {
        height: 6.1rem;
        width: auto;
        max-width: 6.5rem;
        object-fit: contain;
        background: transparent;
        border-radius: 0.4rem;
        margin-right: 0.5rem;
        vertical-align: middle;
        /* Optional: invert for dark mode if needed */
        /* filter: invert(1) brightness(1.2); */
      }
      /* Light-mode widget text overrides */
      body.bg-light .dashboard-card .label {
        color: rgba(33, 37, 41, 0.65) !important; /* much darker for readability */
      }
      body.bg-light .dashboard-card .count,
      body.bg-light .dashboard-card .icon {
        color: rgba(33, 37, 41, 0.85) !important; /* much darker for readability */
      }

      /* Light-mode table and form overrides */
      body.bg-light .table th,
      body.bg-light .table td {
        color: #212529 !important;
      }
      body.bg-light .form-select,
      body.bg-light .form-select option,
      body.bg-light .form-select:focus {
        background-color: #ffffff !important;
        color: #212529 !important;
        border-color: #ced4da !important;
      }
      body.bg-light .form-label {
        color: #212529 !important;
      }
      /* Remove or override any global table/text color that is too light in light mode */
      body.bg-light .table, body.bg-light .table th, body.bg-light .table td, body.bg-light .table thead th {
        color: #212529 !important;
      }
      body.bg-light .table-dark th, body.bg-light .table-dark td {
        color: #f3f6fa !important;
      }
      .card-header, .card-body, .form-label, .form-select, .badge, .nav-link, .modal-title, .modal-body, .btn, .btn-link {
         color: #f3f6fa !important;
      }
      .bg-dark, .card-header.bg-dark, .card-body.bg-dark {
         color: #f3f6fa !important;
      }
      @media (prefers-color-scheme: light) {
        body {
          background-color: #f8f9fa !important;
          color: #212529 !important;
        }
        .sidebar .nav-link {
          color: #23272b !important;
        }
      }
      .progress-bar {
        position: relative;
        overflow: hidden;
      }
      .progress-bar::after {
        content: "";
        position: absolute;
        top: 0; left: 0; bottom: 0;
        width: 40%;
        background: linear-gradient(90deg, rgba(13,110,253,0) 0%, rgba(13,110,253,0.5) 50%, rgba(13,110,253,0) 100%);
        filter: blur(8px);
        opacity: 0.7;
        animation: pulse-glow 1.2s linear infinite;
        pointer-events: none;
      }
      @keyframes pulse-glow {
        0% {
          left: -40%;
          opacity: 0.2;
        }
        50% {
          left: 60%;
          opacity: 0.7;
        }
        100% {
          left: 100%;
          opacity: 0.2;
        }
      }
      @media (max-width: 900px) {
        .sidebar { 
          display: none; 
          position: fixed;
          top: 0; left: 0; bottom: 0;
          width: 80vw; max-width: 320px;
          background: #23272b;
          z-index: 2001;
          transform: translateX(-100%);
          transition: transform 0.3s cubic-bezier(.68,-0.55,.27,1.55);
          box-shadow: 2px 0 12px rgba(0,0,0,0.18);
        }
        .sidebar.open {
          display: block;
          transform: translateX(0);
        }
        .main-content { margin-left: 0; padding: 1rem 0.5rem; }
        .header { padding: 0.75rem 1rem; }
        .dashboard-cards { grid-template-columns: 1fr; gap: 1rem; }
        .dashboard-card { min-width: 0; width: 100%; margin-bottom: 0.5rem; }
        .modal-lg { max-width: 100vw !important; margin: 0; }
        .modal-content { border-radius: 0; min-height: 100vh; }
        .table-responsive { overflow-x: auto; }
        .btn, .form-select, .form-label, .form-control { font-size: 1.1rem; }
      }
      @media (max-width: 600px) {
        .header { font-size: 1rem; }
        .logo-img { height: 2.2rem; }
        .dashboard-card .count { font-size: 1.3rem; }
        .dashboard-card .icon { font-size: 1.3rem; }
        .dashboard-card { padding: 0.7rem; }
        .card-header, .card-body { padding: 0.7rem 0.5rem; }
      }
      .hamburger {
        display: none;
        background: none;
        border: none;
        font-size: 2rem;
        color: #fff;
        margin-right: 1rem;
        z-index: 2002;
      }
      @media (max-width: 900px) {
        .hamburger { display: inline-block; }
      }
      .sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.3);
        z-index: 2000;
      }
      .sidebar.open ~ .sidebar-backdrop {
        display: block;
      }
      .dashboard-card:active {
        background: rgba(13,110,253,0.12);
        box-shadow: 0 2px 12px rgba(13,110,253,0.10);
      }
      .btn, .form-select, .form-control {
        min-height: 2.8rem;
        border-radius: 0.6rem;
      }
      .btn:active {
        transform: scale(0.97);
        box-shadow: 0 1px 4px rgba(13,110,253,0.10);
      }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script type="text/javascript">
function createCondensedPagination({page, totalPages, onPageChange, containerId}) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  function pageBtn(p, label, active=false, disabled=false) {
    const li = document.createElement('li');
    li.className = 'page-item' + (active ? ' active' : '') + (disabled ? ' disabled' : '');
    const a = document.createElement('a');
    a.className = 'page-link';
    a.href = '#';
    a.textContent = label || p;
    a.onclick = function(e) { e.preventDefault(); if (!disabled && p !== page) onPageChange(p); };
    li.appendChild(a);
    return li;
  }
  function ellipsis() {
    const li = document.createElement('li');
    li.className = 'page-item disabled';
    const span = document.createElement('span');
    span.className = 'page-link';
    span.textContent = '...';
    li.appendChild(span);
    return li;
  }
  let pages = [];
  if (totalPages <= 10) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    pages.push(1);
    if (page > 4) pages.push('...');
    for (let i = Math.max(2, page - 2); i <= Math.min(totalPages - 1, page + 2); i++) {
      pages.push(i);
    }
    if (page < totalPages - 3) pages.push('...');
    pages.push(totalPages);
  }
  pages.forEach(p => {
    if (p === '...') {
      container.appendChild(ellipsis());
    } else {
      container.appendChild(pageBtn(p, p, p === page));
    }
  });
}
    </script>
  </head>
  <body>
    <div class="header" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1030; width: 100vw;">
      <button class="hamburger" id="sidebarToggle" aria-label="Open menu"><i class="bi bi-list"></i></button>
      <div class="d-flex align-items-center">
        <!-- Place your logo file at static/logo.png or update the src below -->
        <img src="/static/logo.png" alt="SentinelZero Logo" class="logo-img me-2" style="height: 3.1rem; width: auto; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.12));">
        <b class="me-2">SentinelZero</b> <span class="badge bg-secondary">v1</span>
      </div>
      <div>
        <span class="theme-toggle" id="themeToggle" title="Toggle light/dark"><i class="bi bi-moon-stars"></i></span>
      </div>
      <!-- Progress bar now lives inside the header -->
      <div id="scanProgressBar" 
           class="progress" 
           style="
             position: absolute;
             bottom: 0; left: 0;
             width: 100%;
             height: 4px;
             display: none;
             margin: 0;
           ">
        <div class="progress-bar" role="progressbar"
             style="
               width: 0%;
               background-color: #0d6efd;
               box-shadow: 0 0 8px rgba(13,110,253,0.7);
               transition: width 0.5s ease;
             ">
        </div>
      </div>
    </div>
    <nav class="sidebar d-flex flex-column" id="sidebarNav">
      <a class="nav-link active" href="/"><i class="bi bi-activity me-2"></i> Scan Types</a>
      <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#alertSettingsModal"><i class="bi bi-bell me-2"></i> Alert Settings</a>
      <a class="nav-link" href="/scan-history"><i class="bi bi-clock-history me-2"></i> Scan History</a>
      <a class="nav-link" href="/settings"><i class="bi bi-gear me-2"></i> Settings</a>
    </nav>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    <main class="main-content">
      <div class="dashboard-cards">
        <div class="dashboard-card" onclick="showHostsModal()" style="cursor: pointer;">
          <span class="icon"><i class="bi bi-hdd-network"></i></span>
          <span class="count" id="hostsCount">{{ latest_scan.hosts|length if latest_scan and latest_scan.hosts is defined else 0 }}</span>
          <span class="label">Hosts Found</span>
        </div>
        <div class="dashboard-card" onclick="showPortsModal()" style="cursor: pointer;">
          <span class="icon"><i class="bi bi-plug"></i></span>
          <span class="count" id="portsCount">{{ latest_scan.open_ports if latest_scan and latest_scan.open_ports is defined else 0 }}</span>
          <span class="label">Open Ports</span>
        </div>
        <div class="dashboard-card" onclick="showVulnsModal()" style="cursor: pointer;">
          <span class="icon"><i class="bi bi-bug"></i></span>
          <span class="count" id="vulnsCount">{{ latest_scan.vulns|length if latest_scan and latest_scan.vulns is defined else 0 }}</span>
          <span class="label">Vulns</span>
        </div>
        <div class="dashboard-card" onclick="showLastRunModal()" style="cursor: pointer;">
          <span class="icon"><i class="bi bi-clock"></i></span>
          <span class="count" id="lastRunTime">{{ latest_scan.timestamp.strftime('%b %d, %Y %H:%M') if latest_scan and latest_scan.timestamp else '--' }}</span>
          <span class="label">Last Run Time</span>
        </div>
      </div>
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header">
              <i class="bi bi-list-check"></i> Last 5 Scans
            </div>
            <div class="card-body table-responsive">
              <table class="table table-hover table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Timestamp</th><th>Type</th><th>Hosts</th><th>Vulns</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for scan in scans %}
                  <tr>
                    <td>{{ scan.timestamp.strftime('%b %d, %Y %H:%M') }}</td>
                    <td><span class="badge bg-primary">{{ scan.scan_type }}</span></td>
                    <td>{{ scan.hosts_json|host_count }}</td>
                    <td>{{ scan.vulns_json|length }}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#scanModal{{ loop.index }}"><i class="bi bi-eye"></i></button>
                      <form method="post" action="/clear-scan/{{ scan.id }}" style="display:inline;" class="clear-scan-form" data-scan-id="{{ scan.id }}" data-scan-type="{{ scan.scan_type }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Clear Scan"><i class="bi bi-trash"></i></button>
                      </form>
                      <!-- Modal -->
                      <div class="modal fade" id="scanModal{{ loop.index }}" tabindex="-1" aria-labelledby="scanModalLabel{{ loop.index }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                          <div class="modal-content bg-dark text-light">
                            <div class="modal-header">
                              <h5 class="modal-title me-3" id="scanModalLabel{{ loop.index }}">Scan Details</h5>
                              <button type="button" class="btn btn-outline-secondary btn-sm me-2" style="margin-left: 0.5rem;" title="Copy JSON" onclick="copyScanJson({{ loop.index }})">
                                <i class="bi bi-clipboard"></i>
                              </button>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <table class="table table-sm table-borderless mb-2">
                                <tr><th>Scan Type</th><td>{{ scan.scan_type }}</td></tr>
                                <tr><th>Timestamp</th><td>{{ scan.timestamp.strftime('%b %d, %Y %H:%M') if scan.timestamp else '' }}</td></tr>
                                <tr><th>Hosts Found</th><td>{{ scan.hosts_json|length }}</td></tr>
                                <tr><th>Vulns</th><td>{{ scan.vulns_json|length }}</td></tr>
                                <tr><th>XML Path</th><td><code>{{ scan.raw_xml_path }}</code></td></tr>
                              </table>
                              <div class="mb-2">
                                <b>Hosts:</b>
                                {% if scan.hosts and scan.hosts|length > 0 %}
                                  <ul class="mb-2 ps-3 paginated-hosts" id="hosts-list-{{ loop.index }}">
                                    <!-- Hosts will be paginated by JS -->
                                  </ul>
                                  <nav>
                                    <ul class="pagination pagination-sm" id="hosts-pagination-{{ loop.index }}"></ul>
                                  </nav>
                                  <script type="text/javascript">
                                  (function() {
                                    var hosts = {{ scan.hosts|tojson }};
                                    var perPage = 10;
                                    var page = 1;
                                    var modalId = 'scanModal{{ loop.index }}';
                                    var listId = 'hosts-list-{{ loop.index }}';
                                    var paginationId = 'hosts-pagination-{{ loop.index }}';
                                    function renderHosts() {
                                      var list = document.getElementById(listId);
                                      list.innerHTML = '';
                                      var start = (page-1)*perPage;
                                      var end = Math.min(start+perPage, hosts.length);
                                      for (var i=start; i<end; i++) {
                                        var li = document.createElement('li');
                                        li.textContent = hosts[i];
                                        list.appendChild(li);
                                      }
                                    }
                                    function renderPagination() {
                                      createCondensedPagination({
                                        page: page,
                                        totalPages: Math.ceil(hosts.length/perPage),
                                        onPageChange: function(p) { page = p; renderHosts(); renderPagination(); },
                                        containerId: paginationId
                                      });
                                    }
                                    var modal = document.getElementById(modalId);
                                    if (modal) {
                                      modal.addEventListener('shown.bs.modal', function() {
                                        page = 1;
                                        renderHosts();
                                        renderPagination();
                                      });
                                    }
                                  })();
                                  </script>
                                {% else %}
                                  <span class="text-muted">None found</span>
                                {% endif %}
                              </div>
                              <div class="mb-2">
                                <b>Vulns:</b>
                                {% if scan.vulns and scan.vulns|length > 0 %}
                                  <ul class="mb-2 ps-3 paginated-vulns" id="vulns-list-{{ loop.index }}">
                                    <!-- Vulns will be paginated by JS -->
                                  </ul>
                                  <nav>
                                    <ul class="pagination pagination-sm" id="vulns-pagination-{{ loop.index }}"></ul>
                                  </nav>
                                  <script type="text/javascript">
                                  (function() {
                                    var vulns = {{ scan.vulns|tojson }};
                                    var perPageV = 10;
                                    var pageV = 1;
                                    var modalId = 'scanModal{{ loop.index }}';
                                    var listId = 'vulns-list-{{ loop.index }}';
                                    var paginationId = 'vulns-pagination-{{ loop.index }}';
                                    function renderVulns() {
                                      var listV = document.getElementById(listId);
                                      listV.innerHTML = '';
                                      var start = (pageV-1)*perPageV;
                                      var end = Math.min(start+perPageV, vulns.length);
                                      for (var i=start; i<end; i++) {
                                        var li = document.createElement('li');
                                        li.textContent = vulns[i];
                                        listV.appendChild(li);
                                      }
                                    }
                                    function renderPaginationV() {
                                      createCondensedPagination({
                                        page: pageV,
                                        totalPages: Math.ceil(vulns.length/perPageV),
                                        onPageChange: function(p) { pageV = p; renderVulns(); renderPaginationV(); },
                                        containerId: paginationId
                                      });
                                    }
                                    var modal = document.getElementById(modalId);
                                    if (modal) {
                                      modal.addEventListener('shown.bs.modal', function() {
                                        pageV = 1;
                                        renderVulns();
                                        renderPaginationV();
                                      });
                                    }
                                  })();
                                  </script>
                                {% else %}
                                  <span class="text-muted">None found</span>
                                {% endif %}
                              </div>
                              <button class="btn btn-link p-0 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#rawJson{{ loop.index }}" aria-expanded="false" aria-controls="rawJson{{ loop.index }}">
                                <i class="bi bi-code-slash"></i> Show Raw JSON
                              </button>
                              <div class="collapse" id="rawJson{{ loop.index }}">
                                <pre id="scan-json-{{ loop.index }}">{{ scan|tojson(indent=2) }}</pre>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="5" class="empty-state">
                      <i class="bi bi-emoji-neutral"></i>
                      <div>No scans yet.<br><small>Start your first scan to see results here!</small></div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-play-circle"></i> Trigger New Scan
            </div>
            <div class="card-body">
              <form method="post" action="/scan" id="scanForm">
                <div class="mb-3">
                  <label for="scan_type" class="form-label">Scan Type</label>
                  <select class="form-select" id="scan_type" name="scan_type">
                    <option value="Full TCP">Full TCP</option>
                    <option value="IoT Scan">IoT Scan</option>
                    <option value="Vuln Scripts">Vuln Scripts</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary w-100" id="scanBtn"><i class="bi bi-lightning-charge"></i> <span id="scanBtnText">Start Scan</span> <span id="scanBtnSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span></button>
              </form>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-bell"></i> Alert Settings
            </div>
            <div class="card-body">
              <h6 class="mb-3">Scheduled Scans</h6>
              <form id="scheduleForm">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="sched-enabled" name="enabled">
                  <label class="form-check-label" for="sched-enabled">Enable Scheduled Scan</label>
                </div>
                <div class="mb-3">
                  <label for="sched-scan-type" class="form-label">Scan Type</label>
                  <select class="form-select" id="sched-scan-type" name="scan_type">
                    <option value="Full TCP">Full TCP</option>
                    <option value="IoT Scan">IoT Scan</option>
                    <option value="Vuln Scripts">Vuln Scripts</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="sched-frequency" class="form-label">Frequency</label>
                  <select class="form-select" id="sched-frequency" name="frequency">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly (Mon)</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="sched-time" class="form-label">Time (24h)</label>
                  <input type="time" class="form-control" id="sched-time" name="time" value="03:00">
                </div>
                <button type="submit" class="btn btn-primary w-100">Save Schedule</button>
              </form>
              <div class="mt-3">
                <div><b>Next Scheduled Run:</b> <span id="sched-next-run">--</span></div>
                <div><b>Last Run Status:</b> <span id="sched-last-status">--</span></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <i class="bi bi-terminal"></i> Live Log
            </div>
            <div class="card-body live-log" id="log-panel">
              <div id="log-messages"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div class="toast-container" id="toastContainer"></div>
    <!-- Alert Settings Modal -->
    <div class="modal fade" id="alertSettingsModal" tabindex="-1" aria-labelledby="alertSettingsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="alertSettingsModalLabel">Alert Settings & Scheduled Scans</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-3">Scheduled Scans</h6>
                <table class="table table-hover table-striped align-middle text-light">
                  <thead>
                    <tr>
                      <th>ID</th><th>Type</th><th>Frequency</th><th>Time</th><th>Next Run</th><th>Last Run</th><th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="schedules-table-body">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3">Scheduled Scan Details</h6>
                <div id="scheduledScanResults">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-12">
                <h6 class="mb-3">Recent Scheduled Scan Results</h6>
                <div id="recentScheduledScans">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hosts Modal -->
    <div class="modal fade" id="hostsModal" tabindex="-1" aria-labelledby="hostsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="hostsModalLabel">
              <i class="bi bi-hdd-network me-2"></i>Hosts Found
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="hostsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ports Modal -->
    <div class="modal fade" id="portsModal" tabindex="-1" aria-labelledby="portsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="portsModalLabel">
              <i class="bi bi-plug me-2"></i>Open Ports
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="portsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vulnerabilities Modal -->
    <div class="modal fade" id="vulnsModal" tabindex="-1" aria-labelledby="vulnsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="vulnsModalLabel">
              <i class="bi bi-bug me-2"></i>Vulnerabilities Found
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="vulnsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Last Run Modal -->
    <div class="modal fade" id="lastRunModal" tabindex="-1" aria-labelledby="lastRunModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="lastRunModalLabel">
              <i class="bi bi-clock me-2"></i>Last Run Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="lastRunDetails">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function updateScheduleUI(config) {
  document.getElementById('sched-enabled').checked = !!config.enabled;
  document.getElementById('sched-scan-type').value = config.scan_type || 'Full TCP';
  document.getElementById('sched-frequency').value = config.frequency || 'daily';
  document.getElementById('sched-time').value = config.time || '03:00';
  document.getElementById('sched-next-run').textContent = config.next_run ? new Date(config.next_run).toLocaleString() : '--';
  document.getElementById('sched-last-status').textContent = config.last_run && config.last_run.time ? `${new Date(config.last_run.time).toLocaleString()} (${config.last_run.status})` : '--';
}
function fetchScheduleConfig() {
  fetch('/api/schedule').then(r => r.json()).then(config => {
    updateScheduleUI(config);
    // Optionally update next run/last run here if backend provides it
  });
}
function fetchSchedules() {
  fetch('/api/schedules').then(r => r.json()).then(schedules => {
    const tbody = document.getElementById('schedules-table-body');
    tbody.innerHTML = '';
    schedules.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.id}</td>
        <td>${s.scan_type}</td>
        <td>${s.frequency}</td>
        <td>${s.time}</td>
        <td>${s.next_run ? new Date(s.next_run).toLocaleString() : '--'}</td>
        <td>${s.last_run && s.last_run.time ? new Date(s.last_run.time).toLocaleString() + ' (' + s.last_run.status + ')' : '--'}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule('${s.id}')"><i class="bi bi-trash"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    
    // Also fetch recent scheduled scan results
    fetchScheduledScanResults();
  });
}

function fetchScheduledScanResults() {
  // Get the latest scan that was likely from a scheduled run
  fetch('/api/dashboard-stats').then(r => r.json()).then(data => {
    const resultsDiv = document.getElementById('scheduledScanResults');
    const recentScansDiv = document.getElementById('recentScheduledScans');
    
    if (data.latest_scan_time) {
      resultsDiv.innerHTML = `
        <div class="card bg-dark">
          <div class="card-body">
            <h6 class="card-title">Latest Scheduled Scan</h6>
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Hosts Found:</small><br>
                <strong>${data.hosts_count}</strong>
              </div>
              <div class="col-6">
                <small class="text-muted">Vulnerabilities:</small><br>
                <strong>${data.vulns_count}</strong>
              </div>
            </div>
            <div class="mt-2">
              <small class="text-muted">Last Run:</small><br>
              <strong>${new Date(data.latest_scan_time).toLocaleString()}</strong>
            </div>
            <div class="mt-3">
              <a href="/scan-history" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-eye me-1"></i>View Details
              </a>
            </div>
          </div>
        </div>
      `;
      
      // Fetch recent scheduled scans
      fetch('/scan-history').then(r => r.text()).then(html => {
        // Parse the HTML to extract scan data
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const scanRows = doc.querySelectorAll('tbody tr');
        
        if (scanRows.length > 0) {
          let recentScansHTML = '<div class="table-responsive"><table class="table table-sm table-hover">';
          recentScansHTML += '<thead><tr><th>Timestamp</th><th>Type</th><th>Hosts</th><th>Vulns</th><th>Status</th></tr></thead><tbody>';
          
          // Show last 5 scans
          const recentScans = Array.from(scanRows).slice(0, 5);
          recentScans.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
              const timestamp = cells[0].textContent;
              const type = cells[1].textContent;
              const hosts = cells[2].textContent;
              const vulns = cells[3].textContent;
              const status = parseInt(hosts) > 0 ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning">No Hosts</span>';
              
              recentScansHTML += `<tr>
                <td>${timestamp}</td>
                <td>${type}</td>
                <td>${hosts}</td>
                <td>${vulns}</td>
                <td>${status}</td>
              </tr>`;
            }
          });
          
          recentScansHTML += '</tbody></table></div>';
          recentScansDiv.innerHTML = recentScansHTML;
        } else {
          recentScansDiv.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No recent scheduled scans found.
            </div>
          `;
        }
      }).catch(() => {
        recentScansDiv.innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Unable to load recent scans.
          </div>
        `;
      });
    } else {
      resultsDiv.innerHTML = `
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          No scheduled scan results available yet. 
          Run a scan to see results here.
        </div>
      `;
      recentScansDiv.innerHTML = `
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          No recent scheduled scans found.
        </div>
      `;
    }
  }).catch(() => {
    const resultsDiv = document.getElementById('scheduledScanResults');
    const recentScansDiv = document.getElementById('recentScheduledScans');
    resultsDiv.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Unable to load scan results.
      </div>
    `;
    recentScansDiv.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Unable to load recent scans.
      </div>
    `;
  });
}
function deleteSchedule(id) {
  if (!confirm('Delete this scheduled run?')) return;
  fetch(`/api/schedules/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(resp => {
      if (resp.status === 'ok') {
        showToast('Schedule deleted!', 'success');
        fetchSchedules();
      } else {
        showToast('Failed to delete schedule.', 'danger');
      }
    });
}
document.addEventListener('DOMContentLoaded', function() {
      // Auto-apply OS theme preference
      function applyOsTheme(e) {
        const isDark = e.matches !== undefined ? e.matches : window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.classList.toggle('bg-dark', isDark);
        document.body.classList.toggle('text-light', isDark);
        document.body.classList.toggle('bg-light', !isDark);
        document.body.classList.toggle('text-dark', !isDark);
        const icon = document.getElementById('themeToggle').querySelector('i');
        if (isDark) {
          icon.classList.remove('bi-sun');
          icon.classList.add('bi-moon-stars');
        } else {
          icon.classList.remove('bi-moon-stars');
          icon.classList.add('bi-sun');
        }
      }
      // Initial application
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      applyOsTheme(mediaQuery);
      // Listen for changes
      mediaQuery.addEventListener('change', applyOsTheme);
      // Animated counters for dashboard cards
      function animateCount(id, target) {
        let el = document.getElementById(id);
        let start = 0;
        let end = parseInt(target) || 0;
        let duration = 800;
        let step = Math.ceil(end / (duration / 16));
        let current = start;
        function update() {
          current += step;
          if (current >= end) {
            el.textContent = end;
          } else {
            el.textContent = current;
            requestAnimationFrame(update);
          }
        }
        update();
      }
      // Example: animateCount('hostsCount', 12);
      // TODO: Hook up real values from backend

      // Toast/snackbar function
      function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        toastContainer.appendChild(toast);
        setTimeout(() => { toast.classList.remove('show'); toast.remove(); }, 3500);
      }

      // SocketIO log updates
      if (!window.socket) {
        window.socket = io();
      }
      var socket = window.socket;
      socket.on('scan_log', function(data) {
        console.log('[scan_log event]', data.msg);
        var log = document.getElementById('log-messages');
        log.innerHTML += data.msg + '<br>';
        log.parentElement.scrollTop = log.parentElement.scrollHeight;
      });
      socket.on('scan_progress', function(data) {
        const barWrap = scanProgressBar;
        const bar = barWrap.querySelector('.progress-bar');
        barWrap.style.display = '';
        bar.style.width = data.percent + '%';
      });
      socket.on('scan_complete', function(data) {
        const barWrap = scanProgressBar;
        const bar = barWrap.querySelector('.progress-bar');
        // Always fill to 100% on completion
        barWrap.style.display = '';
        bar.style.width = '100%';
        setTimeout(() => {
          bar.style.width = '0%';
          barWrap.style.display = 'none';
        }, 500);
        showToast('Scan completed!', 'success');
        if (scanProgressInterval) clearInterval(scanProgressInterval);
      });
      let scanProgressInterval = null;
      const scanProgressBar = document.getElementById('scanProgressBar');
      const scanForm = document.getElementById('scanForm');
      const scanBtn = document.getElementById('scanBtn');
      const scanBtnSpinner = document.getElementById('scanBtnSpinner');
      const scanBtnText = document.getElementById('scanBtnText');

      if (scanForm) {
        scanForm.addEventListener('submit', function(e) {
          e.preventDefault();
          scanBtn.disabled = true;
          scanBtnSpinner.classList.remove('d-none');
          scanBtnText.textContent = 'Starting...';
          // show & animate the bar incrementally
          const barWrap = scanProgressBar;
          const bar = barWrap.querySelector('.progress-bar');
          bar.style.width = '0%'; // reset
          barWrap.style.display = '';
          let progress = 0;
          if (scanProgressInterval) clearInterval(scanProgressInterval);
          scanProgressInterval = setInterval(() => {
            if (progress < 80) {
              progress += Math.random() * 5 + 2; // randomize for a more natural feel
              if (progress > 80) progress = 80;
              bar.style.width = progress + '%';
            }
          }, 400);
          setTimeout(() => bar.style.width = '10%', 10); // quick initial bump
          showToast('Scan started!', 'info');
          showToast('You can leave this page and results will continue in the background.', 'info');
          fetch('/scan', {
            method: 'POST',
            body: new FormData(scanForm),
          })
          .then(response => {
            if (!response.ok) throw new Error('Scan failed');
            // Do not reload page; keep log visible
            return response.text();
          })
          .catch(err => {
            showToast('Scan failed to start.', 'danger');
            scanBtn.disabled = false;
            scanBtnSpinner.classList.add('d-none');
            scanBtnText.textContent = 'Start Scan';
            // hide & reset the bar
            if (scanProgressInterval) clearInterval(scanProgressInterval);
            bar.style.width = '0%';
            barWrap.style.display = 'none';
          });
        });
      }
      // Fallback: re-enable after 2 minutes if event missed
      function resetScanButton() {
        scanBtn.disabled = false;
        scanBtnSpinner.classList.add('d-none');
        scanBtnText.textContent = 'Start Scan';
      }
      if (scanForm) {
        scanForm.addEventListener('submit', function(e) {
          setTimeout(resetScanButton, 120000); // 2 minutes
        });
      }

      function copyScanJson(idx) {
        const pre = document.getElementById('scan-json-' + idx);
        if (!pre) return;
        const text = pre.innerText;
        navigator.clipboard.writeText(text).then(() => {
          showToast('Copied scan JSON to clipboard!', 'success');
        }, () => {
          showToast('Failed to copy.', 'danger');
        });
      }

      // AJAX handler for clear scan (trashcan) button
      document.querySelectorAll('.clear-scan-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const scanId = form.getAttribute('data-scan-id');
          const scanType = form.getAttribute('data-scan-type');
          fetch(form.action, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
          .then(response => {
            if (!response.ok) throw new Error('Failed to clear scan');
            // Remove the row from the table
            const row = form.closest('tr');
            if (row) row.remove();
            showToast(`Scan deleted: <b>${scanType}</b>`, 'danger');
          })
          .catch(err => {
            showToast('Failed to delete scan.', 'danger');
          });
        });
      });

      // Sidebar hamburger toggle for mobile
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarNav = document.getElementById('sidebarNav');
      const sidebarBackdrop = document.getElementById('sidebarBackdrop');
      function openSidebar() {
        sidebarNav.classList.add('open');
        sidebarBackdrop.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }
      function closeSidebar() {
        sidebarNav.classList.remove('open');
        sidebarBackdrop.style.display = 'none';
        document.body.style.overflow = '';
      }
      sidebarToggle.addEventListener('click', openSidebar);
      sidebarBackdrop.addEventListener('click', closeSidebar);
      // Close sidebar on nav click (mobile)
      sidebarNav.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', closeSidebar);
      });
      fetchScheduleConfig();
      var scheduleForm = document.getElementById('scheduleForm');
      if (scheduleForm) {
        scheduleForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const data = {
            enabled: document.getElementById('sched-enabled').checked,
            scan_type: document.getElementById('sched-scan-type').value,
            frequency: document.getElementById('sched-frequency').value,
            time: document.getElementById('sched-time').value
          };
          fetch('/api/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(r => r.json())
          .then(resp => {
            showToast('Schedule updated!', 'success');
            updateScheduleUI(resp.config);
            if (resp.next_run !== undefined) {
              document.getElementById('sched-next-run').textContent = resp.next_run ? new Date(resp.next_run).toLocaleString() : '--';
            }
            if (resp.last_run !== undefined) {
              document.getElementById('sched-last-status').textContent = resp.last_run && resp.last_run.time ? `${new Date(resp.last_run.time).toLocaleString()} (${resp.last_run.status})` : '--';
            }
          })
          .catch(() => showToast('Failed to update schedule.', 'danger'));
        });
      }
      var alertSettingsModal = document.getElementById('alertSettingsModal');
      if (alertSettingsModal) {
        alertSettingsModal.addEventListener('show.bs.modal', fetchSchedules);
      }

      // Dashboard card click handlers
      function showHostsModal() {
        // Add click animation
        const card = event.target.closest('.dashboard-card');
        if (card) {
          card.classList.add('clicked');
          setTimeout(() => card.classList.remove('clicked'), 300);
        }
        
        // Fetch latest data from API
        fetch('/api/dashboard-stats').then(r => r.json()).then(data => {
          if (data.hosts_count === 0) {
            showToast('No hosts found in the latest scan.', 'info');
            return;
          }
          
          // Fetch detailed hosts data from the latest scan
          fetch('/api/hosts/latest').then(r => r.json()).then(hostsData => {
            const hostsList = document.getElementById('hostsList');
            const hosts = hostsData.hosts || [];
            
            hostsList.innerHTML = `
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="card bg-dark">
                    <div class="card-body text-center">
                      <h3 class="text-primary">${hosts.length}</h3>
                      <small class="text-muted">Total Hosts Found</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card bg-dark">
                    <div class="card-body text-center">
                      <h3 class="text-info">${new Date().toLocaleDateString()}</h3>
                      <small class="text-muted">Last Updated</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover table-striped">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th>Host IP</th>
                      <th>Status</th>
                      <th>Last Seen</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${hosts.map((host, index) => `
                      <tr>
                        <td>${index + 1}</td>
                        <td><code class="text-primary">${host}</code></td>
                        <td><span class="badge bg-success">Active</span></td>
                        <td>${new Date().toLocaleString()}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              <div class="mt-3">
                <a href="/scan-history" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-2"></i>View Scan History
                </a>
              </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('hostsModal'));
            modal.show();
          }).catch(() => {
            showToast('Unable to fetch detailed hosts data.', 'warning');
          });
        }).catch(() => {
          showToast('Unable to fetch scan statistics.', 'warning');
        });
      }

      function showPortsModal() {
        // Add click animation
        const card = event.target.closest('.dashboard-card');
        if (card) {
          card.classList.add('clicked');
          setTimeout(() => card.classList.remove('clicked'), 300);
        }
        
        // Fetch latest data from API
        fetch('/api/dashboard-stats').then(r => r.json()).then(data => {
          const portsList = document.getElementById('portsList');
          
          portsList.innerHTML = `
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="card bg-dark">
                  <div class="card-body text-center">
                    <h3 class="text-info">${data.hosts_count || 0}</h3>
                    <small class="text-muted">Hosts with Open Ports</small>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-dark">
                  <div class="card-body text-center">
                    <h3 class="text-success">Active</h3>
                    <small class="text-muted">Port Status</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Port Information:</strong> Detailed port information is available in individual scan results. 
              Click on the eye icon in the scan history to view detailed port information for each scan.
            </div>
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>Common Ports</th>
                    <th>Description</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><code>22</code></td>
                    <td>SSH</td>
                    <td><span class="badge bg-warning">Check</span></td>
                  </tr>
                  <tr>
                    <td><code>80</code></td>
                    <td>HTTP</td>
                    <td><span class="badge bg-warning">Check</span></td>
                  </tr>
                  <tr>
                    <td><code>443</code></td>
                    <td>HTTPS</td>
                    <td><span class="badge bg-warning">Check</span></td>
                  </tr>
                  <tr>
                    <td><code>8080</code></td>
                    <td>HTTP Alt</td>
                    <td><span class="badge bg-warning">Check</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-3">
              <a href="/scan-history" class="btn btn-outline-primary">
                <i class="bi bi-clock-history me-2"></i>View Scan History
              </a>
            </div>
          `;
          
          const modal = new bootstrap.Modal(document.getElementById('portsModal'));
          modal.show();
        }).catch(() => {
          showToast('Unable to fetch scan statistics.', 'warning');
        });
      }

      function showVulnsModal() {
        // Add click animation
        const card = event.target.closest('.dashboard-card');
        if (card) {
          card.classList.add('clicked');
          setTimeout(() => card.classList.remove('clicked'), 300);
        }
        
        // Fetch latest data from API
        fetch('/api/dashboard-stats').then(r => r.json()).then(data => {
          if (data.vulns_count === 0) {
            showToast('No vulnerabilities found in the latest scan.', 'info');
            return;
          }
          
          // Fetch detailed vulnerabilities data from the latest scan
          fetch('/api/vulns/latest').then(r => r.json()).then(vulnsData => {
            const vulnsList = document.getElementById('vulnsList');
            const vulns = vulnsData.vulns || [];
            
            vulnsList.innerHTML = `
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="card bg-dark">
                    <div class="card-body text-center">
                      <h3 class="text-danger">${vulns.length}</h3>
                      <small class="text-muted">Total Vulnerabilities</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card bg-dark">
                    <div class="card-body text-center">
                      <h3 class="text-warning">${vulns.filter(v => v.includes('HIGH') || v.includes('CRITICAL')).length}</h3>
                      <small class="text-muted">High/Critical</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover table-striped">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th>Severity</th>
                      <th>Vulnerability Details</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${vulns.map((vuln, index) => {
                      const severity = vuln.includes('HIGH') || vuln.includes('CRITICAL') ? 'danger' : 
                                     vuln.includes('MEDIUM') ? 'warning' : 'info';
                      const severityText = vuln.includes('HIGH') || vuln.includes('CRITICAL') ? 'High' :
                                         vuln.includes('MEDIUM') ? 'Medium' : 'Low';
                      return `
                        <tr>
                          <td>${index + 1}</td>
                          <td><span class="badge bg-${severity}">${severityText}</span></td>
                          <td><code style="white-space: pre-wrap; font-size: 0.9em;">${vuln}</code></td>
                          <td><span class="badge bg-warning">Open</span></td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
              <div class="mt-3">
                <a href="/scan-history" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-2"></i>View Scan History
                </a>
              </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('vulnsModal'));
            modal.show();
          }).catch(() => {
            showToast('Unable to fetch detailed vulnerability data.', 'warning');
          });
        }).catch(() => {
          showToast('Unable to fetch scan statistics.', 'warning');
        });
      }

      function showLastRunModal() {
        // Add click animation
        const card = event.target.closest('.dashboard-card');
        if (card) {
          card.classList.add('clicked');
          setTimeout(() => card.classList.remove('clicked'), 300);
        }
        
        // Fetch latest data from API
        fetch('/api/dashboard-stats').then(r => r.json()).then(data => {
          const lastRunDetails = document.getElementById('lastRunDetails');
          
          if (!data.latest_scan_time) {
            showToast('No scan data available.', 'warning');
            return;
          }
          
          lastRunDetails.innerHTML = `
            <div class="row mb-3">
              <div class="col-md-3">
                <div class="card bg-dark">
                  <div class="card-body text-center">
                    <h3 class="text-primary">${data.total_scans}</h3>
                    <small class="text-muted">Total Scans</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark">
                  <div class="card-body text-center">
                    <h3 class="text-success">${data.hosts_count}</h3>
                    <small class="text-muted">Hosts Found</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark">
                  <div class="card-body text-center">
                    <h3 class="text-danger">${data.vulns_count}</h3>
                    <small class="text-muted">Vulnerabilities</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-dark">
                  <div class="card-body text-center">
                    <h3 class="text-info">${new Date(data.latest_scan_time).toLocaleDateString()}</h3>
                    <small class="text-muted">Last Run</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>Metric</th>
                    <th>Value</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Last Scan Time</td>
                    <td>${new Date(data.latest_scan_time).toLocaleString()}</td>
                    <td><span class="badge bg-success">Complete</span></td>
                  </tr>
                  <tr>
                    <td>Total Scans Run</td>
                    <td>${data.total_scans}</td>
                    <td><span class="badge bg-info">Active</span></td>
                  </tr>
                  <tr>
                    <td>Hosts Discovered</td>
                    <td>${data.hosts_count}</td>
                    <td><span class="badge bg-primary">Found</span></td>
                  </tr>
                  <tr>
                    <td>Vulnerabilities Detected</td>
                    <td>${data.vulns_count}</td>
                    <td><span class="badge bg-warning">Monitor</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-3">
              <a href="/scan-history" class="btn btn-outline-primary">
                <i class="bi bi-clock-history me-2"></i>View Full History
              </a>
            </div>
          `;
          
          const modal = new bootstrap.Modal(document.getElementById('lastRunModal'));
          modal.show();
        }).catch(() => {
          showToast('Unable to fetch scan statistics.', 'warning');
        });
      }
});
    </script>
  </body>
</html>