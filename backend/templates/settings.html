<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Settings - SentinelZero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body, h1, h2, h3, h4, h5, h6 {
        font-family: 'Inter', Arial, sans-serif;
      }
      .header {
        position: fixed;
        top: 0; left: 0; right: 0;
        z-index: 1030;
        width: 100vw;
        background: rgba(24, 26, 27, 0.85);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        color: #fff;
        padding: 0.75rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .sidebar {
        position: fixed;
        top: 64px;
        left: 0;
        bottom: 0;
        width: 220px;
        background: #23272b;
        color: #f8f9fa;
        padding: 2rem 1rem 1rem 1rem;
        box-shadow: 2px 0 12px rgba(0,0,0,0.12), 0 0 0 1px #2c2f34;
        z-index: 1020;
        border-right: 1.5px solid #2c2f34;
      }
      .sidebar .nav-link {
        color: #f3f6fa !important;
        margin-bottom: 0.5rem;
        font-weight: 500;
        transition: background 0.2s, color 0.2s;
        text-shadow: 0 1px 2px rgba(0,0,0,0.18);
      }
      .sidebar .nav-link.active, .sidebar .nav-link:hover {
        background: #343a40;
        border-radius: 0.375rem;
        color: #fff !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        text-shadow: 0 2px 8px rgba(0,0,0,0.18);
      }
      .main-content {
        margin-left: 240px;
        margin-top: 104px;
        padding: 2rem 2rem 2rem 2rem;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        background: rgba(30, 33, 36, 0.6) !important;
        color: #f8f9fa !important;
        border: none !important;
      }
      .card-header {
        background: rgba(24, 26, 27, 0.85) !important;
        border-bottom: none !important;
      }
      .card-body {
        background: rgba(30, 33, 36, 0.6) !important;
      }
      .table, .table th, .table td, .table thead th {
         color: #f3f6fa !important;
      }
      .table-dark th, .table-dark td {
         color: #f3f6fa !important;
      }
      .card-header, .card-body, .form-label, .form-select, .badge, .nav-link, .modal-title, .modal-body, .btn, .btn-link {
         color: #f3f6fa !important;
      }
      .bg-dark, .card-header.bg-dark, .card-body.bg-dark {
         color: #f3f6fa !important;
      }
      .logo-img {
        height: 3.1rem;
        width: auto;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.12));
      }
      .back-btn {
        margin-bottom: 1rem;
      }
      .form-control, .form-select {
        background-color: rgba(30,33,36,0.6) !important;
        color: #f8f9fa !important;
        border-color: #495057 !important;
      }
      .form-control:focus, .form-select:focus {
        background-color: rgba(30,33,36,0.8) !important;
        color: #f8f9fa !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25) !important;
      }
      @media (max-width: 900px) {
        .sidebar { display: none; }
        .main-content { margin-left: 0; }
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    <div class="header">
      <div class="d-flex align-items-center">
        <img src="/static/logo.png" alt="SentinelZero Logo" class="logo-img me-2">
        <b class="me-2">SentinelZero</b> <span class="badge bg-secondary">v1</span>
      </div>
      <div>
        <a href="/" class="btn btn-outline-light btn-sm">Back to Dashboard</a>
      </div>
    </div>
    
    <nav class="sidebar d-flex flex-column">
      <a class="nav-link" href="/"><i class="bi bi-activity me-2"></i> Scan Types</a>
      <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#alertSettingsModal"><i class="bi bi-bell me-2"></i> Alert Settings</a>
      <a class="nav-link" href="/scan-history"><i class="bi bi-clock-history me-2"></i> Scan History</a>
      <a class="nav-link active" href="/settings"><i class="bi bi-gear me-2"></i> Settings</a>
    </nav>
    
    <main class="main-content">
      <div class="back-btn">
        <a href="/" class="btn btn-outline-light"><i class="bi bi-arrow-left me-2"></i>Back to Dashboard</a>
      </div>
      
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header">
              <i class="bi bi-gear me-2"></i> Application Settings
            </div>
            <div class="card-body">
              <form id="appSettingsForm">
                <div class="mb-3">
                  <label for="scanNetwork" class="form-label">Default Scan Network</label>
                  <input type="text" class="form-control" id="scanNetwork" value="172.16.0.0/22" placeholder="e.g., 172.16.0.0/22">
                  <div class="form-text">Network range to scan by default</div>
                </div>
                <div class="mb-3">
                  <label for="scanTimeout" class="form-label">Scan Timeout (minutes)</label>
                  <input type="number" class="form-control" id="scanTimeout" value="30" min="5" max="120">
                  <div class="form-text">Maximum time for a scan to run</div>
                </div>
                <div class="mb-3">
                  <label for="maxConcurrentScans" class="form-label">Max Concurrent Scans</label>
                  <input type="number" class="form-control" id="maxConcurrentScans" value="1" min="1" max="5">
                  <div class="form-text">Maximum number of scans running simultaneously</div>
                </div>
                <div class="mb-3">
                  <label for="logRetention" class="form-label">Log Retention (days)</label>
                  <input type="number" class="form-control" id="logRetention" value="30" min="1" max="365">
                  <div class="form-text">How long to keep scan logs</div>
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header">
              <i class="bi bi-bell me-2"></i> Notification Settings
            </div>
            <div class="card-body">
              <form id="notificationSettingsForm">
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enablePushover" checked>
                    <label class="form-check-label" for="enablePushover">Enable Pushover Notifications</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="pushoverToken" class="form-label">Pushover API Token</label>
                  <input type="password" class="form-control" id="pushoverToken" placeholder="Enter your Pushover API token">
                </div>
                <div class="mb-3">
                  <label for="pushoverUserKey" class="form-label">Pushover User Key</label>
                  <input type="password" class="form-control" id="pushoverUserKey" placeholder="Enter your Pushover user key">
                </div>
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notifyOnScanStart" checked>
                    <label class="form-check-label" for="notifyOnScanStart">Notify on scan start</label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notifyOnScanComplete" checked>
                    <label class="form-check-label" for="notifyOnScanComplete">Notify on scan completion</label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notifyOnVulns" checked>
                    <label class="form-check-label" for="notifyOnVulns">Notify when vulnerabilities found</label>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Notification Settings</button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header">
              <i class="bi bi-info-circle me-2"></i> System Information
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <table class="table table-borderless">
                    <tr><th>Application Version:</th><td>SentinelZero v1.0</td></tr>
                    <tr><th>Python Version:</th><td id="pythonVersion">--</td></tr>
                    <tr><th>Flask Version:</th><td id="flaskVersion">--</td></tr>
                    <tr><th>Database:</th><td>SQLite</td></tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <table class="table table-borderless">
                    <tr><th>Total Scans:</th><td id="totalScans">--</td></tr>
                    <tr><th>Database Size:</th><td id="dbSize">--</td></tr>
                    <tr><th>Last Scan:</th><td id="lastScan">--</td></tr>
                    <tr><th>Uptime:</th><td id="uptime">--</td></tr>
                  </table>
                </div>
              </div>
              <div class="mt-3">
                <button class="btn btn-outline-info btn-sm" onclick="refreshSystemInfo()">
                  <i class="bi bi-arrow-clockwise me-1"></i>Refresh System Info
                </button>
                <button class="btn btn-outline-warning btn-sm ms-2" onclick="clearAllData()">
                  <i class="bi bi-trash me-1"></i>Clear All Data
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Alert Settings Modal -->
    <div class="modal fade" id="alertSettingsModal" tabindex="-1" aria-labelledby="alertSettingsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="alertSettingsModalLabel">Alert Settings & Scheduled Scans</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-3">Scheduled Scans</h6>
                <table class="table table-hover table-striped align-middle text-light">
                  <thead>
                    <tr>
                      <th>ID</th><th>Type</th><th>Frequency</th><th>Time</th><th>Next Run</th><th>Last Run</th><th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="schedules-table-body">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3">Scheduled Scan Details</h6>
                <div id="scheduledScanResults">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-12">
                <h6 class="mb-3">Recent Scheduled Scan Results</h6>
                <div id="recentScheduledScans">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Load settings from localStorage or set defaults
        loadSettings();
        refreshSystemInfo();
        
        // Form submission handlers
        document.getElementById('appSettingsForm').addEventListener('submit', function(e) {
          e.preventDefault();
          saveAppSettings();
        });
        
        document.getElementById('notificationSettingsForm').addEventListener('submit', function(e) {
          e.preventDefault();
          saveNotificationSettings();
        });
      });
      
      function loadSettings() {
        // Load app settings
        const appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
        document.getElementById('scanNetwork').value = appSettings.scanNetwork || '172.16.0.0/22';
        document.getElementById('scanTimeout').value = appSettings.scanTimeout || 30;
        document.getElementById('maxConcurrentScans').value = appSettings.maxConcurrentScans || 1;
        document.getElementById('logRetention').value = appSettings.logRetention || 30;
        
        // Load notification settings
        const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
        document.getElementById('enablePushover').checked = notificationSettings.enablePushover !== false;
        document.getElementById('pushoverToken').value = notificationSettings.pushoverToken || '';
        document.getElementById('pushoverUserKey').value = notificationSettings.pushoverUserKey || '';
        document.getElementById('notifyOnScanStart').checked = notificationSettings.notifyOnScanStart !== false;
        document.getElementById('notifyOnScanComplete').checked = notificationSettings.notifyOnScanComplete !== false;
        document.getElementById('notifyOnVulns').checked = notificationSettings.notifyOnVulns !== false;
      }
      
      function saveAppSettings() {
        const settings = {
          scanNetwork: document.getElementById('scanNetwork').value,
          scanTimeout: parseInt(document.getElementById('scanTimeout').value),
          maxConcurrentScans: parseInt(document.getElementById('maxConcurrentScans').value),
          logRetention: parseInt(document.getElementById('logRetention').value)
        };
        localStorage.setItem('appSettings', JSON.stringify(settings));
        showToast('Application settings saved!', 'success');
      }
      
      function saveNotificationSettings() {
        const settings = {
          enablePushover: document.getElementById('enablePushover').checked,
          pushoverToken: document.getElementById('pushoverToken').value,
          pushoverUserKey: document.getElementById('pushoverUserKey').value,
          notifyOnScanStart: document.getElementById('notifyOnScanStart').checked,
          notifyOnScanComplete: document.getElementById('notifyOnScanComplete').checked,
          notifyOnVulns: document.getElementById('notifyOnVulns').checked
        };
        localStorage.setItem('notificationSettings', JSON.stringify(settings));
        showToast('Notification settings saved!', 'success');
      }
      
      function refreshSystemInfo() {
        // Simulate loading system info
        document.getElementById('pythonVersion').textContent = '3.8+';
        document.getElementById('flaskVersion').textContent = '2.0+';
        document.getElementById('totalScans').textContent = 'Loading...';
        document.getElementById('dbSize').textContent = 'Loading...';
        document.getElementById('lastScan').textContent = 'Loading...';
        document.getElementById('uptime').textContent = 'Loading...';
        
        // Fetch real data from API
        fetch('/api/dashboard-stats')
          .then(response => response.json())
          .then(data => {
            document.getElementById('totalScans').textContent = data.total_scans || 0;
            document.getElementById('lastScan').textContent = data.latest_scan_time ? new Date(data.latest_scan_time).toLocaleString() : 'Never';
          })
          .catch(() => {
            document.getElementById('totalScans').textContent = 'Error';
            document.getElementById('lastScan').textContent = 'Error';
          });
        
        // Simulate other system info
        setTimeout(() => {
          document.getElementById('dbSize').textContent = '~1.2 MB';
          document.getElementById('uptime').textContent = '2 days, 3 hours';
        }, 1000);
      }
      
      function clearAllData() {
        if (confirm('Are you sure you want to clear all scan data? This action cannot be undone.')) {
          // This would typically call an API endpoint to clear data
          showToast('Data cleared successfully!', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      }
      
      function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      // Alert Settings Modal Functions
      function fetchSchedules() {
        fetch('/api/schedules').then(r => r.json()).then(schedules => {
          const tbody = document.getElementById('schedules-table-body');
          tbody.innerHTML = '';
          schedules.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${s.id}</td>
              <td>${s.scan_type}</td>
              <td>${s.frequency}</td>
              <td>${s.time}</td>
              <td>${s.next_run ? new Date(s.next_run).toLocaleString() : '--'}</td>
              <td>${s.last_run && s.last_run.time ? new Date(s.last_run.time).toLocaleString() + ' (' + s.last_run.status + ')' : '--'}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule('${s.id}')"><i class="bi bi-trash"></i></button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          
          fetchScheduledScanResults();
        });
      }
      
      function fetchScheduledScanResults() {
        fetch('/api/dashboard-stats').then(r => r.json()).then(data => {
          const resultsDiv = document.getElementById('scheduledScanResults');
          const recentScansDiv = document.getElementById('recentScheduledScans');
          
          if (data.latest_scan_time) {
            resultsDiv.innerHTML = `
              <div class="card bg-dark">
                <div class="card-body">
                  <h6 class="card-title">Latest Scheduled Scan</h6>
                  <div class="row">
                    <div class="col-6">
                      <small class="text-muted">Hosts Found:</small><br>
                      <strong>${data.hosts_count}</strong>
                    </div>
                    <div class="col-6">
                      <small class="text-muted">Vulnerabilities:</small><br>
                      <strong>${data.vulns_count}</strong>
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Last Run:</small><br>
                    <strong>${new Date(data.latest_scan_time).toLocaleString()}</strong>
                  </div>
                  <div class="mt-3">
                    <a href="/scan-history" class="btn btn-outline-primary btn-sm">
                      <i class="bi bi-eye me-1"></i>View Details
                    </a>
                  </div>
                </div>
              </div>
            `;
            
            // Show recent scans from API
            fetch('/api/dashboard-stats').then(r => r.json()).then(stats => {
              recentScansDiv.innerHTML = `
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Latest Scan Summary:</strong><br>
                  • Total Scans: ${stats.total_scans}<br>
                  • Hosts Found: ${stats.hosts_count}<br>
                  • Vulnerabilities: ${stats.vulns_count}<br>
                  • Last Run: ${stats.latest_scan_time ? new Date(stats.latest_scan_time).toLocaleString() : 'Never'}
                </div>
              `;
            });
          } else {
            resultsDiv.innerHTML = `
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No scheduled scan results available yet. 
                Run a scan to see results here.
              </div>
            `;
            recentScansDiv.innerHTML = `
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No recent scheduled scans found.
              </div>
            `;
          }
        }).catch(() => {
          const resultsDiv = document.getElementById('scheduledScanResults');
          const recentScansDiv = document.getElementById('recentScheduledScans');
          resultsDiv.innerHTML = `
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Unable to load scan results.
            </div>
          `;
          recentScansDiv.innerHTML = `
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Unable to load recent scans.
            </div>
          `;
        });
      }
      
      function deleteSchedule(id) {
        if (!confirm('Delete this scheduled run?')) return;
        fetch(`/api/schedules/${id}`, { method: 'DELETE' })
          .then(r => r.json())
          .then(resp => {
            if (resp.status === 'ok') {
              fetchSchedules();
            }
          });
      }
      
      // Initialize Alert Settings modal
      var alertSettingsModal = document.getElementById('alertSettingsModal');
      if (alertSettingsModal) {
        alertSettingsModal.addEventListener('show.bs.modal', fetchSchedules);
      }
    </script>
  </body>
</html>